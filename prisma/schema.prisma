// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION MODELS
// ============================================

enum Role {
  USER
  ADMIN
  PROVIDER
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  role          Role      @default(USER)
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations - Auth
  sessions Session[]
  accounts Account[]

  // Relations - App
  transactions   Transaction[]
  categoryRules  CategoryRule[]
  amazonInvoices AmazonInvoice[]
  trips          Trip[]
  forecastWeeks  ForecastWeek[]
  forecasts      Forecast[]

  // Relations - Import Batches
  tripImportBatches    TripImportBatch[]
  invoiceImportBatches InvoiceImportBatch[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@index([expiresAt])
  @@map("verification")
}

// ============================================
// BOOKKEEPING MODELS
// ============================================

// P&L Inclusion is determined by CategoryType:
// - REVENUE:           ✅ In P&L (positive)
// - CONTRA_REVENUE:    ✅ In P&L (reduces revenue)
// - COGS:              ✅ In P&L (negative - direct costs)
// - OPERATING_EXPENSE: ✅ In P&L (negative - indirect costs)
// - EQUITY:            ❌ Not in P&L (owner transactions)
// - UNCATEGORIZED:     ❌ Not in P&L (needs review)

enum CategoryType {
  REVENUE           // Amazon Relay Payment
  CONTRA_REVENUE    // Refunds (reduces revenue)
  COGS              // Cost of Goods Sold (Driver Wages, Payroll Taxes)
  OPERATING_EXPENSE // Indirect business costs
  EQUITY            // Owner Contribution (not in P&L)
  UNCATEGORIZED     // Not yet categorized
}

model Category {
  id          String       @id @default(uuid())
  name        String       @unique
  type        CategoryType
  color       String       @default("#6b7280") // Hex color for UI
  isSystem    Boolean      @default(false) // System categories can't be deleted
  sortOrder   Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  transactions  Transaction[]
  categoryRules CategoryRule[]

  @@map("category")
}

enum ReviewStatus {
  PENDING
  REVIEWED
  FLAGGED
}

model Transaction {
  id            String       @id @default(uuid())
  userId        String
  categoryId    String?
  importBatchId String?

  // Bank data fields
  details        String // DEBIT, CREDIT, CHECK, DSLIP
  postingDate    DateTime
  description    String
  amount         Decimal       @db.Decimal(12, 2)
  type           String // ACH_DEBIT, ACH_CREDIT, DEBIT_CARD, etc.
  balance        Decimal?      @db.Decimal(12, 2)
  checkOrSlipNum String?

  // Categorization
  aiCategorized  Boolean      @default(false)
  aiConfidence   Float? // 0-1 confidence score
  manualOverride Boolean      @default(false)
  reviewStatus   ReviewStatus @default(PENDING)

  // Matching
  amazonInvoiceId String? // Link to Amazon invoice if matched

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  category      Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  importBatch   ImportBatch?   @relation(fields: [importBatchId], references: [id])
  amazonInvoice AmazonInvoice? @relation(fields: [amazonInvoiceId], references: [id])

  @@index([userId, postingDate])
  @@index([categoryId])
  @@index([importBatchId])
  @@map("transaction")
}

model ImportBatch {
  id           String   @id @default(uuid())
  userId       String
  fileName     String
  fileType     String // CSV, XLSX
  recordCount  Int
  status       String   @default("completed") // processing, completed, failed
  errorMessage String?
  createdAt    DateTime @default(now())

  // Relations
  transactions Transaction[]

  @@map("import_batch")
}

// ============================================
// TRIP IMPORT BATCH - Track trip CSV imports
// ============================================

model TripImportBatch {
  id     String @id @default(uuid())
  userId String

  // File info
  fileName String
  fileHash String? // MD5 hash for duplicate file detection

  // Import metadata
  importedAt DateTime @default(now())

  // Period covered by trips in this import
  periodStart DateTime // Earliest trip scheduledDate
  periodEnd   DateTime // Latest trip scheduledDate

  // Import statistics
  tripCount     Int // Total trips in file
  newTripsCount Int // Actually imported (new)
  skippedCount  Int // Skipped as duplicates
  loadCount     Int // Total loads
  canceledCount Int @default(0)

  // SNAPSHOT: Projections at time of import (IMMUTABLE)
  projectedTours        Int
  projectedLoads        Int
  projectedTourPay      Decimal @db.Decimal(12, 2)
  projectedAccessorials Decimal @db.Decimal(12, 2)
  projectedTotal        Decimal @db.Decimal(12, 2)

  // Status
  status       String  @default("completed") // processing, completed, failed
  errorMessage String?

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  trips Trip[]

  @@index([userId, importedAt])
  @@index([userId, periodStart, periodEnd])
  @@index([fileHash])
  @@map("trip_import_batch")
}

// ============================================
// INVOICE IMPORT BATCH - Track invoice imports
// ============================================

model InvoiceImportBatch {
  id       String @id @default(uuid())
  userId   String
  fileName String
  fileHash String?

  importedAt DateTime @default(now())

  // Stats
  invoiceCount   Int
  lineItemCount  Int
  matchedTrips   Int
  unmatchedTrips Int

  status String @default("completed")

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices AmazonInvoice[]

  @@index([userId, importedAt])
  @@map("invoice_import_batch")
}

model CategoryRule {
  id         String @id @default(uuid())
  userId     String
  categoryId String

  // Matching criteria
  pattern   String // Regex or text pattern
  matchType String @default("contains") // contains, startsWith, endsWith, regex
  field     String @default("description") // description, type, details

  // Rule metadata
  priority Int     @default(0) // Higher = checked first
  isActive Boolean @default(true)
  hitCount Int     @default(0) // Track usage

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@map("category_rule")
}

// ============================================
// FORECASTING MODELS
// ============================================

model AmazonInvoice {
  id     String @id @default(uuid())
  userId String

  // Link to import batch
  importBatchId String?

  // Invoice header
  invoiceNumber String  @unique
  routeDomicile String? // Minneapolis, MN
  equipment     String? // 26-Foot Box Truck
  programType   String? // Fixed and Variable - Flex

  // Totals (calculated from line items)
  totalTourPay      Decimal @default(0) @db.Decimal(12, 2)
  totalAccessorials Decimal @default(0) @db.Decimal(12, 2)
  totalAdjustments  Decimal @default(0) @db.Decimal(12, 2)
  totalPay          Decimal @default(0) @db.Decimal(12, 2)

  // Period
  periodStart DateTime?
  periodEnd   DateTime?
  paymentDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lineItems    AmazonInvoiceLineItem[]
  transactions Transaction[]
  importBatch  InvoiceImportBatch?     @relation(fields: [importBatchId], references: [id])

  @@index([userId, paymentDate])
  @@index([importBatchId])
  @@map("amazon_invoice")
}

enum InvoiceItemType {
  TOUR_COMPLETED
  LOAD_COMPLETED
  ADJUSTMENT_DISPUTE
  ADJUSTMENT_OTHER
}

model AmazonInvoiceLineItem {
  id        String @id @default(uuid())
  invoiceId String

  // Identifiers
  tripId String
  loadId String? // Null for Tour rows

  // Dates
  startDate DateTime?
  endDate   DateTime?

  // Details
  operator      String? // Solo, Team
  distanceMiles Decimal @default(0) @db.Decimal(10, 2)
  durationHours Decimal @default(0) @db.Decimal(6, 2)

  // Item type
  itemType InvoiceItemType

  // Pay breakdown
  baseRate      Decimal @default(0) @db.Decimal(10, 2) // $452 for tours
  fuelSurcharge Decimal @default(0) @db.Decimal(10, 2) // Accessorial
  detention     Decimal @default(0) @db.Decimal(10, 2)
  tonu          Decimal @default(0) @db.Decimal(10, 2) // Truck Ordered Not Used
  grossPay      Decimal @default(0) @db.Decimal(10, 2)

  comments String?

  createdAt DateTime @default(now())

  // Relations
  invoice AmazonInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([tripId])
  @@map("amazon_invoice_line_item")
}

enum TripStage {
  UPCOMING
  IN_PROGRESS
  COMPLETED
  CANCELED
}

model Trip {
  id     String  @id @default(uuid())
  userId String
  weekId String? // Group trips by week

  // Link to import batch
  importBatchId String?

  // Identifiers from CSV
  tripId    String    // Amazon Trip ID (T-112YY5BG)
  tripStage TripStage @default(UPCOMING) // From CSV: Upcoming, Canceled

  // Equipment & Operator
  equipmentType String? // "26' Truck"
  operatorType  String? // "Single Driver"

  // Dates
  scheduledDate DateTime // Derived from first load's Stop 1 Planned Arrival

  // Load tracking (calculated from TripLoad records)
  projectedLoads Int  @default(0) // Auto-calculated: count non-bobtail delivery stops
  actualLoads    Int? // Manually updated nightly by user

  // Original projected values (IMMUTABLE - never change after creation)
  originalProjectedLoads   Int?
  originalProjectedRevenue Decimal? @db.Decimal(10, 2)

  // Revenue tracking
  estimatedAccessorial Decimal? @db.Decimal(10, 2) // Sum of non-bobtail Estimated Cost
  projectedRevenue     Decimal? @db.Decimal(10, 2) // $452 + estimatedAccessorial
  actualRevenue        Decimal? @db.Decimal(10, 2) // From Amazon Invoice

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  week        ForecastWeek?    @relation(fields: [weekId], references: [id])
  loads       TripLoad[]
  importBatch TripImportBatch? @relation(fields: [importBatchId], references: [id])

  @@unique([userId, tripId])
  @@index([userId, scheduledDate])
  @@index([userId, tripStage])
  @@index([weekId])
  @@index([importBatchId])
  @@map("trip")
}

model TripLoad {
  id       String @id @default(uuid())
  tripDbId String // References Trip.id

  // Identifiers from CSV
  loadId           String // Amazon Load ID (115XL2QFJ)
  facilitySequence String? // Route: "MSP7->DDU-MSP7-1_0420_01"

  // Status
  loadExecutionStatus String @default("Not Started") // Not Started, Cancelled, Completed

  // Bobtail detection (CRITICAL for load counting)
  truckFilter String?  // "DDU-MSP7-1_0420_01" or "BobtailMovementAnnotation"
  isBobtail   Boolean @default(false) // TRUE if truckFilter = "BobtailMovementAnnotation"

  // Distance & Cost
  estimateDistance Decimal  @default(0) @db.Decimal(10, 2) // Miles
  estimatedCost    Decimal? @db.Decimal(10, 2) // Accessorial for this load segment

  // Shipper info
  shipperAccount String? // "OutboundDDU" or "AZNG"

  // Stop details (up to 7 stops per load row)
  stop1           String? // Stop ID (MSP7, PY25793, etc.)
  stop1PlannedArr DateTime?
  stop2           String?
  stop2PlannedArr DateTime?
  stop3           String?
  stop3PlannedArr DateTime?
  stop4           String?
  stop4PlannedArr DateTime?
  stop5           String?
  stop5PlannedArr DateTime?
  stop6           String?
  stop6PlannedArr DateTime?
  stop7           String?
  stop7PlannedArr DateTime?

  createdAt DateTime @default(now())

  // Relations
  trip Trip @relation(fields: [tripDbId], references: [id], onDelete: Cascade)

  @@index([tripDbId])
  @@index([loadId])
  @@map("trip_load")
}

enum ForecastStatus {
  PROJECTED
  IN_PROGRESS
  COMPLETED
}

model ForecastWeek {
  id     String @id @default(uuid())
  userId String

  // Week identification
  weekStart  DateTime // Monday
  weekEnd    DateTime // Sunday
  weekNumber Int // Week of year
  year       Int

  // Inputs
  truckCount  Int @default(2)
  nightsCount Int @default(7)

  // Projected (before week - calculated from Trips import)
  projectedTours        Int     @default(0)
  projectedLoads        Int     @default(0)
  projectedTourPay      Decimal @default(0) @db.Decimal(12, 2)
  projectedAccessorials Decimal @default(0) @db.Decimal(12, 2)
  projectedTotal        Decimal @default(0) @db.Decimal(12, 2)

  // Actual (after invoice - calculated from Amazon Invoice import)
  actualTours        Int?
  actualLoads        Int?
  actualTourPay      Decimal? @db.Decimal(12, 2)
  actualAccessorials Decimal? @db.Decimal(12, 2)
  actualAdjustments  Decimal? @db.Decimal(12, 2)
  actualTotal        Decimal? @db.Decimal(12, 2)

  // Variance (calculated: actual - projected)
  variance        Decimal? @db.Decimal(12, 2)
  variancePercent Float?

  // Link to Amazon Invoice for this week
  amazonInvoiceId String?

  // Lock projections when invoice arrives (IMMUTABLE after this)
  projectionLockedAt DateTime?

  notes  String?
  status ForecastStatus @default(PROJECTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  trips Trip[]

  @@unique([userId, weekStart])
  @@index([userId, year, weekNumber])
  @@index([userId, status])
  @@map("forecast_week")
}

model Forecast {
  id     String @id @default(uuid())
  userId String

  // Scenario details
  name        String
  description String?
  isDefault   Boolean @default(false)

  // Input parameters
  truckCount      Int
  nightsPerWeek   Int     @default(7)
  toursPerTruck   Int     @default(1)
  avgLoadsPerTour Decimal @default(4) @db.Decimal(4, 2)

  // Rates
  dtrRate            Decimal @default(452) @db.Decimal(10, 2)
  avgAccessorialRate Decimal @default(77) @db.Decimal(10, 2)

  // Labor costs
  hourlyWage         Decimal @default(20) @db.Decimal(10, 2)
  hoursPerNight      Decimal @default(10) @db.Decimal(4, 2)
  overtimeMultiplier Decimal @default(1.5) @db.Decimal(3, 2)
  payrollTaxRate     Decimal @default(0.0765) @db.Decimal(5, 4) // 7.65%
  workersCompRate    Decimal @default(0.05) @db.Decimal(5, 4) // 5%

  // Calculated results
  weeklyRevenue      Decimal @db.Decimal(12, 2)
  weeklyLaborCost    Decimal @db.Decimal(12, 2)
  weeklyOverhead     Decimal @default(0) @db.Decimal(12, 2)
  weeklyProfit       Decimal @db.Decimal(12, 2)
  contributionMargin Decimal @db.Decimal(10, 2) // Per truck per day

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("forecast")
}
